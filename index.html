<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âá∫Âã§ÁÆ°ÁêÜÁ≥ªÁµ±</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --c1: #ff7675; --c2: #55efc4; --c3: #74b9ff; --c4: #ffe119;
            --border-thick: 2px solid #2f3542;
            --border-thin: 1px solid #dcdde1;
        }
        * { box-sizing: border-box; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: #f1f2f6; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* Â†±Ë°®ÂàáÊèõÈ†ÇÊ¨Ñ */
        .id-zone { 
            background: #2f3542; color: white; width: 100%; max-width: 900px; 
            padding: 12px 20px; border-radius: 12px 12px 0 0; 
            display: flex; align-items: center; justify-content: space-between; 
            flex-wrap: wrap; gap: 10px;
        }
        .report-controls { display: flex; align-items: center; gap: 10px; }
        .report-select { padding: 6px 10px; border-radius: 6px; border: none; background: #fff; font-weight: bold; cursor: pointer; min-width: 150px; }
        .btn-add { background: #2ecc71; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-add:hover { background: #27ae60; }

        .card { background: white; padding: 25px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 900px; margin-bottom: 30px; }
        
        .header-top { display: flex; flex-direction: column; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 10px; }
        select { padding: 8px 15px; border-radius: 8px; border: 2px solid #ddd; background: #fff; font-size: 14px; font-weight: bold; }
        .big-date-display { font-size: clamp(2.5rem, 8vw, 3.8rem); font-weight: 900; color: #2f3640; line-height: 1; }

        .config-zone { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px; }
        @media (min-width: 600px) { .config-zone { grid-template-columns: repeat(4, 1fr); } }
        .config-item { display: flex; align-items: center; gap: 8px; background: #fafafa; padding: 8px; border-radius: 6px; }
        .color-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
        input[type="text"] { border: none; border-bottom: 2px solid #ddd; background: transparent; padding: 2px; width: 100%; font-size: 14px; font-weight: bold; outline: none; }

        .calendar-container { width: 100%; }
        .weekday-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #2f3542; color: white; border-radius: 6px 6px 0 0; margin-bottom: 2px; }
        .weekday { text-align: center; font-weight: bold; padding: 12px 0; font-size: 14px; }
        
        .week-row { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 10px; border-top: var(--border-thick); border-left: var(--border-thick); }
        .day { min-height: 110px; aspect-ratio: 0.85; border-right: var(--border-thick); border-bottom: var(--border-thick); display: flex; flex-direction: column; position: relative; background: white; }
        .day.empty { background: #f9f9f9; border-right: var(--border-thin); border-bottom: var(--border-thin); }
        .day-num { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1; font-size: 36px; font-weight: 900; pointer-events: none; color: rgba(0,0,0,0.06); }
        
        .layer-container { display: flex; flex-direction: column; height: 100%; width: 100%; z-index: 2; }
        .layer { flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: transparent; overflow: hidden; white-space: nowrap; padding: 0 5px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .layer.active { color: #2f3542; }
        .layer.l1.active { background: var(--c1); }
        .layer.l2.active { background: var(--c2); }
        .layer.l3.active { background: var(--c3); }
        .layer.l4.active { background: var(--c4); }

        .stats { margin-top: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; background: #2f3542; border-radius: 8px; overflow: hidden; border: 2px solid #2f3542; }
        @media (min-width: 600px) { .stats { grid-template-columns: repeat(4, 1fr); } }
        .stat-box { background: white; padding: 15px; text-align: center; }
        .stat-num { font-size: 22px; font-weight: bold; display: block; color: #2f3542; }

        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        button.action { flex: 1; padding: 12px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; min-width: 120px; color: white; }
        .btn-excel { background: #217346; }
        .btn-clear { background: #ff4757; }
        .btn-backup { background: #57606f; }
        .btn-restore { background: #747d8c; }
    </style>
</head>
<body>

<div class="id-zone">
    <div class="report-controls">
        <span>üìÇ ÈÅ∏ÊìáÂ†±Ë°®Ôºö</span>
        <select id="reportList" class="report-select" onchange="switchReport()"></select>
        <button class="btn-add" onclick="createNewReport()">+ Êñ∞Â¢ûÂ†±Ë°®</button>
    </div>
    <small id="currentIdDisplay">ÁõÆÂâçÁè≠Ë°®: Default</small>
</div>

<div class="card">
    <div class="header-top">
        <div class="controls">
            <select id="yearSelect"></select>
            <select id="monthSelect"></select>
        </div>
        <div class="big-date-display" id="bigDate">2026 / 02</div>
    </div>

    <div class="config-zone">
        <div class="config-item"><div class="color-dot" style="background:var(--c1)"></div> <input type="text" id="t1" value="Êó©Áè≠" oninput="saveCurrentData()"></div>
        <div class="config-item"><div class="color-dot" style="background:var(--c2)"></div> <input type="text" id="t2" value="ÊôöÁè≠" oninput="saveCurrentData()"></div>
        <div class="config-item"><div class="color-dot" style="background:var(--c3)"></div> <input type="text" id="t3" value="Âä†Áè≠" oninput="saveCurrentData()"></div>
        <div class="config-item"><div class="color-dot" style="background:var(--c4)"></div> <input type="text" id="t4" value="‰ºëÂÅá" oninput="saveCurrentData()"></div>
    </div>

    <div class="calendar-container">
        <div class="weekday-header">
            <div class="weekday">‰∏Ä</div><div class="weekday">‰∫å</div><div class="weekday">‰∏â</div>
            <div class="weekday">Âõõ</div><div class="weekday">‰∫î</div><div class="weekday">ÂÖ≠</div><div class="weekday">Êó•</div>
        </div>
        <div id="calendarWeeks"></div>
    </div>

    <div class="stats" id="statsArea"></div>

    <div class="btn-group">
        <button class="action btn-excel" onclick="exportExcel()">üìä ÂåØÂá∫ Excel</button>
        <button class="action btn-backup" onclick="exportBackup()">üíæ ÂåØÂá∫ÂÇô‰ªΩ</button>
        <button class="action btn-restore" onclick="document.getElementById('fileInput').click()">üìÇ ÈÇÑÂéüÂÇô‰ªΩ</button>
        <button class="action btn-clear" onclick="clearCurrentMonth()">üóëÔ∏è Ê∏ÖÁ©∫Êú¨Êúà</button>
    </div>
    <input type="file" id="fileInput" style="display:none" onchange="importBackup(event)" accept=".json">
</div>

<script>
    // ÁÆ°ÁêÜÂ†±Ë°® ID ÂàóË°®
    let allReportIds = JSON.parse(localStorage.getItem('all_report_ids')) || ['Default_Report'];
    let currentId = localStorage.getItem('current_report_id') || 'Default_Report';
    
    let scheduleData = {};
    let configNames = ["Êó©Áè≠", "ÊôöÁè≠", "Âä†Áè≠", "‰ºëÂÅá"];

    // ÂàùÂßãÂåñËàáÂä†Ëºâ
    function init() {
        updateReportListUI();
        loadDataForId(currentId);
        
        const yS = document.getElementById('yearSelect');
        const mS = document.getElementById('monthSelect');
        const now = new Date();
        for(let i=now.getFullYear()-2; i<=now.getFullYear()+5; i++) yS.add(new Option(i + " Âπ¥", i));
        for(let i=0; i<12; i++) mS.add(new Option((i+1) + " Êúà", i));
        yS.value = now.getFullYear(); mS.value = now.getMonth();
        yS.onchange = mS.onchange = render;
        render();
    }

    function updateReportListUI() {
        const list = document.getElementById('reportList');
        list.innerHTML = '';
        allReportIds.forEach(id => {
            const opt = new Option(id, id);
            if (id === currentId) opt.selected = true;
            list.add(opt);
        });
        document.getElementById('currentIdDisplay').innerText = `ÁõÆÂâçÂ†±Ë°®: ${currentId}`;
    }

    function loadDataForId(id) {
        currentId = id;
        localStorage.setItem('current_report_id', id);
        scheduleData = JSON.parse(localStorage.getItem(`schedule_data_${id}`)) || {};
        configNames = JSON.parse(localStorage.getItem(`schedule_config_${id}`)) || ["Êó©Áè≠", "ÊôöÁè≠", "Âä†Áè≠", "‰ºëÂÅá"];
        
        // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°Ü
        configNames.forEach((name, i) => document.getElementById('t' + (i + 1)).value = name);
    }

    function saveCurrentData() {
        configNames = [1,2,3,4].map(i => document.getElementById('t'+i).value);
        localStorage.setItem(`schedule_data_${currentId}`, JSON.stringify(scheduleData));
        localStorage.setItem(`schedule_config_${currentId}`, JSON.stringify(configNames));
        updateUI();
    }

    function createNewReport() {
        const name = prompt("Ë´ãËº∏ÂÖ•Êñ∞Â†±Ë°®ÂêçÁ®± (ID):", "Êñ∞Â†±Ë°®");
        if (name && name.trim()) {
            const trimmedName = name.trim();
            if (!allReportIds.includes(trimmedName)) {
                allReportIds.push(trimmedName);
                localStorage.setItem('all_report_ids', JSON.stringify(allReportIds));
            }
            loadDataForId(trimmedName);
            updateReportListUI();
            render();
        }
    }

    function switchReport() {
        const selectedId = document.getElementById('reportList').value;
        loadDataForId(selectedId);
        updateReportListUI();
        render();
    }

    function render() {
        const y = parseInt(document.getElementById('yearSelect').value);
        const m = parseInt(document.getElementById('monthSelect').value);
        document.getElementById('bigDate').innerText = `${y} / ${(m+1).toString().padStart(2, '0')}`;
        
        const weeksArea = document.getElementById('calendarWeeks');
        weeksArea.innerHTML = '';
        
        const firstDay = new Date(y, m, 1).getDay();
        const offset = (firstDay === 0 ? 6 : firstDay - 1);
        const daysInMonth = new Date(y, m+1, 0).getDate();

        let currentDay = 1;
        let weekRow = document.createElement('div');
        weekRow.className = 'week-row';

        for(let i=0; i<offset; i++) weekRow.appendChild(Object.assign(document.createElement('div'), {className:'day empty'}));

        while(currentDay <= daysInMonth) {
            const dateStr = `${y}-${m+1}-${currentDay}`;
            if(!scheduleData[dateStr]) scheduleData[dateStr] = { types: [false,false,false,false], notes: ["","","",""] };
            
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            dayDiv.innerHTML = `<div class="day-num">${currentDay}</div>`;
            const container = document.createElement('div');
            container.className = 'layer-container';
            
            for(let L=0; L<4; L++) {
                const layer = document.createElement('div');
                layer.className = `layer l${L+1} ${scheduleData[dateStr].types[L] ? 'active' : ''}`;
                layer.innerText = scheduleData[dateStr].notes[L] || "";
                layer.onclick = () => { scheduleData[dateStr].types[L] = !scheduleData[dateStr].types[L]; saveCurrentData(); render(); };
                layer.ondblclick = (e) => {
                    e.stopPropagation();
                    const val = prompt("Ëº∏ÂÖ•ÂÇôË®ª:", scheduleData[dateStr].notes[L]);
                    if (val !== null) { scheduleData[dateStr].notes[L] = val; saveCurrentData(); render(); }
                };
                container.appendChild(layer);
            }
            dayDiv.appendChild(container);
            weekRow.appendChild(dayDiv);
            if (weekRow.children.length === 7) { weeksArea.appendChild(weekRow); weekRow = document.createElement('div'); weekRow.className = 'week-row'; }
            currentDay++;
        }
        if (weekRow.children.length > 0) {
            while (weekRow.children.length < 7) weekRow.appendChild(Object.assign(document.createElement('div'), {className:'day empty'}));
            weeksArea.appendChild(weekRow);
        }
        updateUI();
    }

    function updateUI() {
        const y = document.getElementById('yearSelect').value;
        const m = parseInt(document.getElementById('monthSelect').value) + 1;
        const counts = [0, 0, 0, 0];
        Object.keys(scheduleData).forEach(key => {
            if(key.startsWith(`${y}-${m}-`)) scheduleData[key].types.forEach((val, idx) => { if(val) counts[idx]++; });
        });
        document.getElementById('statsArea').innerHTML = [1,2,3,4].map(i => `
            <div class="stat-box">
                <span style="font-size:11px; font-weight:bold; color:#888">${configNames[i-1]}</span>
                <span class="stat-num">${counts[i-1]}</span>
            </div>
        `).join('');
    }

    function clearCurrentMonth() {
        const y = document.getElementById('yearSelect').value;
        const m = parseInt(document.getElementById('monthSelect').value) + 1;
        if(confirm(`Á¢∫ÂÆöÊ∏ÖÁ©∫ [${currentId}] ÁöÑ ${y}Âπ¥${m}Êúà Ë≥áÊñôÔºü`)) {
            Object.keys(scheduleData).forEach(k => { if(k.startsWith(`${y}-${m}-`)) delete scheduleData[k]; });
            saveCurrentData(); render();
        }
    }

    function exportBackup() {
        const backup = { id: currentId, data: scheduleData, config: configNames };
        const blob = new Blob([JSON.stringify(backup)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ÂÇô‰ªΩ_${currentId}_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                const importedId = imported.id || "Imported_Report";
                if (!allReportIds.includes(importedId)) {
                    allReportIds.push(importedId);
                    localStorage.setItem('all_report_ids', JSON.stringify(allReportIds));
                }
                currentId = importedId;
                scheduleData = imported.data;
                configNames = imported.config;
                saveCurrentData();
                location.reload();
            } catch (err) { alert("ËÆÄÂèñÂ§±Êïó"); }
        };
        reader.readAsText(file);
    }

    function exportExcel() {
        const y = document.getElementById('yearSelect').value;
        const m = parseInt(document.getElementById('monthSelect').value) + 1;
        const data = [["Êó•Êúü", ...configNames, "ÂÇôË®ªÂåØÁ∏Ω"]];
        const daysInMonth = new Date(y, m, 0).getDate();
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${m}-${d}`;
            const info = scheduleData[dateStr] || { types:[], notes:[] };
            const row = [`${y}/${m}/${d}`];
            configNames.forEach((_, i) => row.push(info.types[i] ? "V" : ""));
            row.push(info.notes.filter(n => n).join('; '));
            data.push(row);
        }
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Schedule");
        XLSX.writeFile(wb, `ÊéíÁè≠Ë°®_${currentId}_${y}_${m}.xlsx`);
    }

    init();
</script>

</body>
</html>
