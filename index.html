<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºå‹¤ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --c1: #ff7675; --c2: #55efc4; --c3: #74b9ff; --c4: #ffe119;
            --border-thick: 2px solid #2f3542;
            --border-thin: 1px solid #dcdde1;
            --gold: #f1c40f;
        }
        * { box-sizing: border-box; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        body { background: #f1f2f6; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .id-zone { 
            background: #2f3542; color: white; width: 100%; max-width: 950px; 
            padding: 15px 25px; border-radius: 12px 12px 0 0; 
            display: flex; align-items: center; justify-content: space-between; 
            flex-wrap: wrap; gap: 10px;
        }
        .report-controls { display: flex; align-items: center; gap: 10px; }
        .report-select, .setting-select { padding: 6px; border-radius: 6px; border: none; font-weight: bold; }
        .status-tag { font-size: 12px; color: #00d8ff; border: 1px solid #00d8ff; padding: 2px 8px; border-radius: 10px; min-width: 120px; text-align: center; }

        .card { background: white; padding: 20px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 950px; }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .big-date-display { font-size: 2.5rem; font-weight: 900; color: #2d3436; }

        .config-zone { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .config-item { display: flex; align-items: center; gap: 5px; background: #f9f9f9; padding: 8px; border-radius: 6px; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; }
        .config-item input { border: none; border-bottom: 1px solid #ccc; background: transparent; width: 100%; font-size: 14px; outline: none; }

        .calendar-container { width: 100%; border-top: var(--border-thick); }
        .weekday-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #2f3542; color: white; }
        .weekday { text-align: center; padding: 10px; font-size: 14px; }
        
        .week-row { display: grid; grid-template-columns: repeat(7, 1fr); border-left: var(--border-thick); }
        .day { min-height: 120px; border-right: var(--border-thick); border-bottom: var(--border-thick); display: flex; flex-direction: column; transition: 0.2s; background: white; }
        .day.empty { background: #f1f2f6; }
        .day.checked-in { background: #e8f8f5 !important; }
        
        .day-header { background: #fdfdfd; padding: 2px 8px; font-size: 13px; font-weight: bold; color: #999; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .check-btn { cursor: pointer; font-size: 14px; color: #ccc; }
        .day.checked-in .check-btn { color: #27ae60; }

        .layer-container { flex: 1; display: flex; flex-direction: column; }
        .layer { flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: transparent; }
        .layer.active { color: #2f3542; }
        .layer.l1.active { background: var(--c1); }
        .layer.l2.active { background: var(--c2); }
        .layer.l3.active { background: var(--c3); }
        .layer.l4.active { background: var(--c4); }

        .achievement-zone { background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 12px; padding: 15px; margin-top: 20px; text-align: center; position: relative; overflow: hidden; }
        .ach-title { font-size: 14px; color: #636e72; font-weight: bold; margin-bottom: 10px; display: block; }
        .progress-container { width: 100%; height: 20px; background: #dfe6e9; border-radius: 10px; overflow: hidden; margin: 10px 0; border: 1px solid #ddd; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #55efc4, #00b894); transition: width 0.8s ease; }
        .progress-bar.perfect { background: linear-gradient(90deg, #ffe66d, #ffc048); box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); }
        .ach-text { font-size: 18px; font-weight: 900; color: #2d3436; }
        .perfect-msg { color: #d35400; font-weight: bold; display: none; animation: bounce 0.5s infinite alternate; }

        .stats-zone { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #2f3542; border: 2px solid #2f3542; border-radius: 8px; margin-top: 15px; overflow: hidden; }
        .stat-box { background: white; padding: 10px; text-align: center; }
        .stat-label { font-size: 11px; color: #888; font-weight: bold; display: block; }
        .stat-value { font-size: 20px; font-weight: 900; color: #2d3436; }

        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        button.action { flex: 1; padding: 12px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; color: white; min-width: 140px; transition: 0.2s; }
        .btn-save { background: #0984e3; }
        .btn-load { background: #6c5ce7; }
        .btn-excel { background: #217346; }
        button:hover { filter: brightness(1.1); }
        
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    </style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="id-zone">
    <div class="report-controls">
        <span>ğŸ“‚ å ±è¡¨ï¼š</span>
        <select id="reportList" class="report-select" onchange="switchReport()"></select>
        <button style="background:#2ecc71; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="createNewReport()">+æ–°å¢</button>
        <span style="margin-left:10px">ğŸ“… é¦–æ—¥ï¼š</span>
        <select id="startDay" class="setting-select" onchange="render()">
            <option value="1">é€±ä¸€</option>
            <option value="0">é€±æ—¥</option>
        </select>
    </div>
    <div class="status-tag" id="syncStatus">é›²ç«¯å°±ç·’</div>
</div>

<div class="card">
    <div class="header-top">
        <div class="big-date-display" id="bigDate">2026 / 02</div>
        <div>
            <select id="yearSelect" onchange="render()"></select>
            <select id="monthSelect" onchange="render()"></select>
        </div>
    </div>

    <div class="config-zone">
        <div class="config-item"><div class="color-dot" style="background:var(--c1)"></div><input type="text" id="t1" oninput="saveLocal()"></div>
        <div class="config-item"><div class="color-dot" style="background:var(--c2)"></div><input type="text" id="t2" oninput="saveLocal()"></div>
        <div class="config-item"><div class="color-dot" style="background:var(--c3)"></div><input type="text" id="t3" oninput="saveLocal()"></div>
        <div class="config-item"><div class="color-dot" style="background:var(--c4)"></div><input type="text" id="t4" oninput="saveLocal()"></div>
    </div>

    <div id="weekdayHeader" class="weekday-header"></div>
    <div id="calendarWeeks"></div>

    <div class="achievement-zone">
        <span class="ach-title">ğŸ† ç•¶æœˆæ‰“å¡é”æˆç‡</span>
        <div class="ach-text"><span id="checkCount">0</span> / <span id="totalDaysCount">0</span> å¤© (<span id="percentText">0%</span>)</div>
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="perfectMsg" class="perfect-msg">âœ¨ å¤ªæ£’äº†ï¼æœ¬æœˆé”æˆ 100% å®Œç¾é»äº®ï¼ âœ¨</div>
    </div>

    <div id="statsZone" class="stats-zone"></div>

    <div class="btn-group">
        <button class="action btn-save" id="btnSave" onclick="syncToCloud()">â˜ï¸ å„²å­˜è‡³é›²ç«¯</button>
        <button class="action btn-load" id="btnLoad" onclick="loadFromCloud()">ğŸ“¥ ä¸‹è¼‰é›²ç«¯è³‡æ–™</button>
        <button class="action btn-excel" onclick="exportExcel()">ğŸ“Š åŒ¯å‡º Excel</button>
        <button class="action" style="background:#ff4757;" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæœ¬æœˆ</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz93-meRJyykGkoblEjjR_MzWBwmEsB9XUpyWLWIGuy6jfmxr5iKMQPoduKXOeyd3ho/exec";
    let allReportIds = JSON.parse(localStorage.getItem('reports_v3')) || ['Default_Report'];
    let currentId = localStorage.getItem('current_id_v3') || 'Default_Report';
    let scheduleData = {};
    let configNames = [];

    function init() {
        const yS = document.getElementById('yearSelect');
        const mS = document.getElementById('monthSelect');
        const now = new Date();
        for(let i=now.getFullYear()-1; i<=now.getFullYear()+3; i++) yS.add(new Option(i, i));
        for(let i=0; i<12; i++) mS.add(new Option(i+1, i));
        yS.value = now.getFullYear(); mS.value = now.getMonth();
        updateReportUI();
        loadLocal(currentId);
        render();
    }

    function updateReportUI() {
        const list = document.getElementById('reportList');
        list.innerHTML = '';
        allReportIds.forEach(id => list.add(new Option(id, id, id===currentId, id===currentId)));
    }

    function loadLocal(id) {
        currentId = id;
        localStorage.setItem('current_id_v3', id);
        scheduleData = JSON.parse(localStorage.getItem(`data_${id}`)) || {};
        configNames = JSON.parse(localStorage.getItem(`cfg_${id}`)) || ["æŠ–éŸ³", "YouTube", "å‡ºå‹¤", "ä¼‘å‡"];
        configNames.forEach((n, i) => document.getElementById('t'+(i+1)).value = n);
    }

    function saveLocal() {
        configNames = [1,2,3,4].map(i => document.getElementById('t'+i).value);
        localStorage.setItem(`data_${currentId}`, JSON.stringify(scheduleData));
        localStorage.setItem(`cfg_${currentId}`, JSON.stringify(configNames));
        updateStats();
    }

    // å…¨è‡ªå‹•èƒŒæ™¯åŒæ­¥è£œä¸
    async function silentLoadFromCloud() {
        const status = document.getElementById('syncStatus');
        status.innerText = "ğŸ” æ­£åœ¨æª¢æŸ¥é›²ç«¯...";
        try {
            const response = await fetch(`${API_URL}?action=load&reportId=${encodeURIComponent(currentId)}`);
            const text = await response.text();
            if(text !== "NotFound" && text.trim() !== "") {
                const imported = JSON.parse(text);
                scheduleData = imported.data;
                configNames = imported.config;
                saveLocal();
                render();
                status.innerText = "âœ… è‡ªå‹•åŒæ­¥æˆåŠŸ";
            } else {
                status.innerText = "â˜ï¸ é›²ç«¯ç„¡æ­¤å ±è¡¨";
            }
        } catch (e) {
            status.innerText = "âš ï¸ è‡ªå‹•é€£ç¶²å¤±æ•—";
        }
    }

    async function syncToCloud() {
        const btn = document.getElementById('btnSave');
        btn.disabled = true; btn.innerText = "åŒæ­¥ä¸­...";
        const payload = JSON.stringify({ data: scheduleData, config: configNames });
        try {
            const finalUrl = `${API_URL}?action=save&reportId=${encodeURIComponent(currentId)}&payload=${encodeURIComponent(payload)}`;
            await fetch(finalUrl, { method: 'GET', mode: 'no-cors' });
            document.getElementById('syncStatus').innerText = "âœ… é›²ç«¯å·²æ›´æ–°";
            btn.innerText = "â˜ï¸ å„²å­˜å®Œæˆ";
        } catch (e) { alert("åŒæ­¥å¤±æ•—"); }
        finally { setTimeout(() => { btn.disabled = false; btn.innerText = "â˜ï¸ å„²å­˜è‡³é›²ç«¯"; }, 1500); }
    }

    async function loadFromCloud() {
        const btn = document.getElementById('btnLoad');
        if(!confirm("ç¢ºå®šè¦æ‰‹å‹•ä¸‹è¼‰é›²ç«¯è³‡æ–™å—ï¼Ÿ\né€™å°‡è¦†è“‹æ‚¨ç›®å‰æœªå­˜æª”çš„å…§å®¹ã€‚")) return;
        btn.disabled = true; btn.innerText = "ä¸‹è¼‰ä¸­...";
        try {
            const response = await fetch(`${API_URL}?action=load&reportId=${encodeURIComponent(currentId)}`);
            const text = await response.text();
            if(text === "NotFound") { alert("é›²ç«¯æ‰¾ä¸åˆ°æ­¤ ID çš„å ±è¡¨è³‡æ–™ã€‚"); } 
            else {
                const imported = JSON.parse(text);
                scheduleData = imported.data;
                configNames = imported.config;
                saveLocal();
                location.reload();
            }
        } catch (e) { alert("è®€å–å¤±æ•—"); }
        finally { btn.disabled = false; btn.innerText = "ğŸ“¥ ä¸‹è¼‰é›²ç«¯è³‡æ–™"; }
    }

    function toggleCheckIn(dateStr) {
        if (!scheduleData[dateStr]) scheduleData[dateStr] = { types:[false,false,false,false], notes:["","","",""] };
        scheduleData[dateStr].checked = !scheduleData[dateStr].checked;
        saveLocal();
        render();
    }

    function render() {
        const y = parseInt(document.getElementById('yearSelect').value);
        const m = parseInt(document.getElementById('monthSelect').value);
        const startDay = parseInt(document.getElementById('startDay').value);
        document.getElementById('bigDate').innerText = `${y} / ${(m+1).toString().padStart(2, '0')}`;
        const labels = startDay === 1 ? ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"] : ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
        document.getElementById('weekdayHeader').innerHTML = labels.map(l => `<div class="weekday">${l}</div>`).join('');
        const weeksArea = document.getElementById('calendarWeeks');
        weeksArea.innerHTML = '';
        const firstDate = new Date(y, m, 1);
        const dayIdx = firstDate.getDay();
        const offset = startDay === 1 ? (dayIdx === 0 ? 6 : dayIdx - 1) : dayIdx;
        const daysInMonth = new Date(y, m+1, 0).getDate();
        let cur = 1;
        let row = document.createElement('div');
        row.className = 'week-row';
        for(let i=0; i<offset; i++) row.appendChild(Object.assign(document.createElement('div'), {className:'day empty'}));
        while(cur <= daysInMonth) {
            const dStr = `${y}-${m+1}-${cur}`;
            if(!scheduleData[dStr]) scheduleData[dStr] = { types:[false,false,false,false], notes:["","","",""], checked: false };
            const dayDiv = document.createElement('div');
            dayDiv.className = `day ${scheduleData[dStr].checked ? 'checked-in' : ''}`;
            const isChecked = scheduleData[dStr].checked;
            dayDiv.innerHTML = `
                <div class="day-header">
                    <span style="cursor:pointer" onclick="toggleCheckIn('${dStr}')">${cur}</span>
                    <span class="check-btn" onclick="toggleCheckIn('${dStr}')">${isChecked ? 'ğŸ”¥' : 'ğŸ”˜'}</span>
                </div>`;
            const container = document.createElement('div');
            container.className = 'layer-container';
            for(let L=0; L<4; L++) {
                const layer = document.createElement('div');
                layer.className = `layer l${L+1} ${scheduleData[dStr].types[L] ? 'active' : ''}`;
                layer.innerText = scheduleData[dStr].notes[L] || "";
                layer.onclick = () => { scheduleData[dStr].types[L] = !scheduleData[dStr].types[L]; saveLocal(); render(); };
                layer.ondblclick = () => {
                    const v = prompt("å‚™è¨»:", scheduleData[dStr].notes[L]);
                    if(v !== null) { scheduleData[dStr].notes[L] = v; saveLocal(); render(); }
                };
                container.appendChild(layer);
            }
            dayDiv.appendChild(container);
            row.appendChild(dayDiv);
            if(row.children.length === 7) { weeksArea.appendChild(row); row = document.createElement('div'); row.className = 'week-row'; }
            cur++;
        }
        if(row.children.length > 0) {
            while(row.children.length < 7) row.appendChild(Object.assign(document.createElement('div'), {className:'day empty'}));
            weeksArea.appendChild(row);
        }
        updateStats();
    }

    function updateStats() {
        const y = document.getElementById('yearSelect').value;
        const m = parseInt(document.getElementById('monthSelect').value) + 1;
        const daysInMonth = new Date(y, m, 0).getDate();
        const counts = [0, 0, 0, 0];
        let checkedCount = 0;
        Object.keys(scheduleData).forEach(key => {
            if(key.startsWith(`${y}-${m}-`)) {
                scheduleData[key].types.forEach((active, i) => { if(active) counts[i]++; });
                if(scheduleData[key].checked) checkedCount++;
            }
        });
        document.getElementById('statsZone').innerHTML = configNames.map((name, i) => `
            <div class="stat-box"><span class="stat-label">${name}</span><span class="stat-value">${counts[i]}</span></div>
        `).join('');
        const percent = Math.floor((checkedCount / daysInMonth) * 100);
        document.getElementById('checkCount').innerText = checkedCount;
        document.getElementById('totalDaysCount').innerText = daysInMonth;
        document.getElementById('percentText').innerText = percent + "%";
        const bar = document.getElementById('progressBar');
        bar.style.width = percent + "%";
        const msg = document.getElementById('perfectMsg');
        if (percent === 100) {
            bar.classList.add('perfect');
            msg.style.display = 'block';
            if (window.lastPerfectMonth !== `${y}-${m}`) { fireConfetti(); window.lastPerfectMonth = `${y}-${m}`; }
        } else {
            bar.classList.remove('perfect');
            msg.style.display = 'none';
        }
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = [];
        for(let i=0; i<100; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                size: Math.random() * 8 + 4,
                color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                v: Math.random() * 3 + 2
            });
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); p.y += p.v;
            });
            if(particles[0].y < canvas.height) requestAnimationFrame(draw);
            else ctx.clearRect(0,0,canvas.width, canvas.height);
        }
        draw();
    }

    // æ•´åˆå¾Œçš„åˆ‡æ›å ±è¡¨é‚è¼¯
    async function switchReport() { 
        const selectedId = document.getElementById('reportList').value;
        loadLocal(selectedId); 
        render(); 
        // å¦‚æœæœ¬åœ°ç«¯å®Œå…¨æ²’æœ‰æ—¥æœŸè³‡æ–™ï¼Œè‡ªå‹•è·‘ä¸€æ¬¡é›²ç«¯æª¢æŸ¥
        if (Object.keys(scheduleData).length <= 4) { // é è¨­ config åªæœ‰ 4 å€‹ key
            await silentLoadFromCloud(); 
        }
    }

    // æ•´åˆå¾Œçš„æ–°å¢å ±è¡¨é‚è¼¯
    async function createNewReport() {
        const n = prompt("æ–°å ±è¡¨ ID:");
        if(n && n.trim()) {
            const id = n.trim();
            if(!allReportIds.includes(id)) {
                allReportIds.push(id);
                localStorage.setItem('reports_v3', JSON.stringify(allReportIds));
            }
            loadLocal(id); 
            updateReportUI(); 
            render();
            // æ–°å¢å¾Œè‡ªå‹•è©¢å•é›²ç«¯æœ‰ç„¡æ­¤ ID è³‡æ–™
            await silentLoadFromCloud();
        }
    }

    function clearData() {
        if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬æœˆï¼Ÿ")) {
            const y = document.getElementById('yearSelect').value;
            const m = parseInt(document.getElementById('monthSelect').value) + 1;
            Object.keys(scheduleData).forEach(k => { if(k.startsWith(`${y}-${m}-`)) delete scheduleData[k]; });
            saveLocal(); render();
        }
    }

    function exportExcel() {
        const y = document.getElementById('yearSelect').value;
        const m = parseInt(document.getElementById('monthSelect').value) + 1;
        const data = [["æ—¥æœŸ", ...configNames, "æ‰“å¡ç‹€æ…‹", "å‚™è¨»å½™æ•´"]];
        for(let d=1; d<=new Date(y, m, 0).getDate(); d++) {
            const info = scheduleData[`${y}-${m}-${d}`] || { types:[], notes:[], checked: false };
            data.push([`${y}/${m}/${d}`, ...info.types.map(t => t?"V":""), info.checked ? "å·²ç¢ºèª" : "", info.notes.filter(n=>n).join('; ')]);
        }
        XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.aoa_to_sheet(data), "Schedule"), `æ’ç­_${currentId}.xlsx`);
    }

    init();
</script>
</body>
</html>
